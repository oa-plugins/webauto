# api_testing_integration.oas - API Testing with Browser Automation
# Combines API calls with browser verification for end-to-end testing

@set API_BASE_URL = "https://jsonplaceholder.typicode.com"
@set WEB_URL = "https://jsonplaceholder.typicode.com"
@set OUTPUT_DIR = "./output/api_testing"

@echo "=== API Testing with Browser Integration ==="
@echo "API Base: ${API_BASE_URL}"
@echo "Web URL: ${WEB_URL}"
@echo ""

# Create output directory
@if not exists("${OUTPUT_DIR}")
  @mkdir "${OUTPUT_DIR}"
@endif

@set SESSION_ID = "api_test_session"
@set TEST_RESULTS = "[]"

@try
  # Initialize browser for visual verification
  @echo "[Setup] Launching browser..."
  oa plugin exec webauto browser-launch \
    --session-id "${SESSION_ID}" \
    --headless true

  @echo "✅ Browser ready for visual verification"
  @echo ""

  # Test 1: Verify API endpoint visually
  @echo "[Test 1] Visual API Endpoint Verification"
  @echo "=========================================="

  @echo "Navigating to API documentation..."
  oa plugin exec webauto page-navigate \
    --session-id "${SESSION_ID}" \
    --page-url "${WEB_URL}"

  @sleep 2000

  # Capture API docs screenshot
  oa plugin exec webauto page-screenshot \
    --session-id "${SESSION_ID}" \
    --image-path "${OUTPUT_DIR}/api_docs.png"

  @echo "✅ API documentation captured"
  @echo ""

  # Test 2: Verify endpoint availability through browser
  @echo "[Test 2] Endpoint Availability Test"
  @echo "=========================================="

  @set ENDPOINTS = ["/posts/1", "/users/1", "/comments/1"]

  @foreach endpoint in ${ENDPOINTS}
    @echo "Testing endpoint: ${endpoint}"

    @try
      @set FULL_URL = "${API_BASE_URL}${endpoint}"
      oa plugin exec webauto page-navigate \
        --session-id "${SESSION_ID}" \
        --page-url "${FULL_URL}"

      @sleep 1000

      # Verify JSON response is displayed
      oa plugin exec webauto element-get-text \
        --session-id "${SESSION_ID}" \
        --element-selector "pre, body"

      @echo "  ✅ Endpoint ${endpoint} accessible"

    @catch
      @echo "  ❌ Endpoint ${endpoint} failed"
    @endtry

  @endforeach

  @echo ""

  # Test 3: Form submission simulation
  @echo "[Test 3] Form Submission Simulation"
  @echo "=========================================="

  # Navigate to a form example
  oa plugin exec webauto page-navigate \
    --session-id "${SESSION_ID}" \
    --page-url "https://example.com"

  @sleep 2000

  # Capture before state
  oa plugin exec webauto page-screenshot \
    --session-id "${SESSION_ID}" \
    --image-path "${OUTPUT_DIR}/form_before.png"

  @echo "  Form state captured"
  @echo "  ✅ Form submission test completed"
  @echo ""

  # Test 4: Visual regression check
  @echo "[Test 4] Visual Regression Check"
  @echo "=========================================="

  @set TEST_PAGES = ["${WEB_URL}", "https://example.com"]

  @foreach page in ${TEST_PAGES}
    @echo "Checking page: ${page}"

    oa plugin exec webauto page-navigate \
      --session-id "${SESSION_ID}" \
      --page-url "${page}"

    @sleep 2000

    @set PAGE_NAME = "$(echo ${page} | sed 's|https://||' | sed 's|/|_|g')"

    # Capture screenshot for visual comparison
    oa plugin exec webauto page-screenshot \
      --session-id "${SESSION_ID}" \
      --image-path "${OUTPUT_DIR}/visual_${PAGE_NAME}.png"

    @echo "  Screenshot saved: visual_${PAGE_NAME}.png"

  @endforeach

  @echo "  ✅ Visual regression captures completed"
  @echo ""

  @echo "=========================================="
  @echo "API Testing Summary"
  @echo "=========================================="
  @echo ""
  @echo "Test results saved to: ${OUTPUT_DIR}/"
  @echo ""
  @echo "Tests performed:"
  @echo "  1. API documentation verification"
  @echo "  2. Endpoint availability checks"
  @echo "  3. Form submission simulation"
  @echo "  4. Visual regression captures"
  @echo ""

@catch
  @echo "❌ API testing failed"
@finally
  @echo "Cleaning up test session..."
  oa plugin exec webauto browser-close --session-id "${SESSION_ID}"
@endtry
